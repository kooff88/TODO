## 搜索引擎

它是一个技术驱动的产品。所谓技术驱动是指，搜索引擎实现起来，技术难度非常大，技术的好坏直接决定了这个产品的核心竞争力。

搜索引擎的设计与实现中，会用到大量的算法。

如何在一台机器上（假设这台机器的内存是 8GB， 硬盘是 100 多 GB），通过少量的代码，实现一个小型搜索引擎

搜索引擎大致可以分为四个部分：搜集、分析、索引、查询。

```
搜集，就是我们常说的利用爬虫爬取网页。
分析，主要负责网页内容抽取、分词，构建临时索引，计算 PageRank 值这几部分工作。
索引，主要负责通过分析阶段得到的临时索引，构建倒排索引。
查询，主要负责响应用户的请求，根据倒排索引获取相关网页，计算网页排名，返回查询结果给用户。
```

### 搜集

搜索引擎把整个互联网看作数据结构中的有向图，把每个页面看作一个顶点。  
如果某个页面中包含另外一个页面的链接，那我们就在两个顶点之间连一条有向边。  
我们可以利用图的遍历搜索算法，来遍历整个互联网中的网页

1. 待爬取网页链接文件：links.bin

支持断点续爬。  
把整个页面看作一个大的字符串，然后利用字符串匹配算法，在这个大字符串中，搜索这样一个网页标签，然后顺序读取之间的字符串。这其实就是网页链接。

2. 网页判重文件：bloom_filter.bin

布隆过滤器存储在内存中,那机器宕机重启之后，布隆过滤器就被清空了。这样就可能导致大量已经爬取的网页会被重复爬取。  
定期地（比如每隔半小时）将布隆过滤器持久化到磁盘中，存储在 bloom_filter.bin 文件中。

3. 原始网页存储文件：doc_raw.bin

我们可以设置每个文件的大小不能超过一定的值（比如 1GB）。  
随着越来越多的网页被添加到文件中，文件的大小就会越来越大，当超过 1GB 的时候，我们就创建一个新的文件，用来存储新爬取的网页。

4. 网页链接及其编号的对应文件：doc_id.bin

网页编号实际上就是给每个网页分配一个唯一的 ID，方便我们后续对网页进行分析、索引。

我们维护一个中心的计数器，每爬取到一个网页之后，就从计数器中拿一个号码，分配给这个网页，  
然后计数器加一。在存储网页的同时，我们将网页链接跟编号之间的对应关系，存储在另一个 doc_id.bin 文件中。

```
爬虫在爬取网页的过程中，涉及的四个重要的文件，我就介绍完了。其中，links.bin 和 bloom_filter.bin 这两个文件是爬虫自身所用的。
另外的两个（doc_raw.bin、doc_id.bin）是作为搜集阶段的成果，供后面的分析、索引、查询用的
```

### 分析

第一个是抽取网页文本信息，第二个是分词并创建临时索引

1. 抽取网页文本信息

依靠 HTML 标签来抽取网页中的文本信息。这个抽取的过程，大体可以分为两步。

第一步是去掉 JavaScript 代码、CSS 格式以及下拉框中的内容（因为下拉框在用户不操作的情况下，也是看不到的）。  
利用 AC 自动机这种多模式串匹配算法，在网页这个大字符串中，一次性查找

第二步是去掉所有 HTML 标签。这一步也是通过字符串匹配算法来实现的。过程跟第一步类似，我就不重复讲了。

2. 分词并创建临时索引

对于英文网页来说，分词非常简单。我们只需要通过空格、标点符号等分隔符，将每个单词分割开来就可以了

字典也叫词库，里面包含大量常用的词语（我们可以直接从网上下载别人整理好的）。  
我们借助词库并采用最长匹配规则，来对文本进行分词。所谓最长匹配，也就是匹配尽可能长的词语。

单词与网页之间的对应关系，写入到一个临时索引文件中（tmp_Index.bin），这个临时索引文件用来构建倒排索引文件。

使用散列表，记录已经编过号的单词。拿分割出来的单词，先到散列表中查找，如果找到，那就直接使用已有的编号；  
如果没有找到，我们再去计数器中拿号码，并且将这个新单词以及编号添加到散列表中。

```
经过分析阶段，我们得到了两个重要的文件。它们分别是临时索引文件（tmp_index.bin）和单词编号文件（term_id.bin）。
```

### 索引

索引阶段主要负责将分析阶段产生的临时索引，构建成倒排索引

多路归并排序

临时索引很大，所以一般基于内存的排序算法就没法处理这个问题了。  
我们可以用之前讲到的归并排序的处理思想，将其分割成多个小文件，先对每个小文件独立排序，最后再合并在一起。

```
经过索引阶段的处理，我们得到了两个有价值的文件，它们分别是倒排索引文件（index.bin）
和记录单词编号在索引文件中的偏移位置的文件（term_offset.bin）。
```

### 查询

利用之前产生的几个文件，来实现最终的用户搜索功能。

```
doc_id.bin：记录网页链接和编号之间的对应关系。

term_id.bin：记录单词和编号之间的对应关系。

index.bin：倒排索引文件，记录每个单词编号以及对应包含它的网页编号列表。

term_offsert.bin：记录每个单词编号在倒排索引文件中的偏移位置。
```

当用户在搜索框中，输入某个查询文本的时候，我们先对用户输入的文本进行分词处理。假设分词之后，我们得到 k 个单词。

我们拿这 k 个单词，去 term_id.bin 对应的散列表中，查找对应的单词编号。经过这个查询之后，我们得到了这 k 个单词对应的单词编号。

我们拿这 k 个单词编号，去 term_offset.bin 对应的散列表中，查找每个单词编号在倒排索引文件中的偏移位置。  
经过这个查询之后，我们得到了 k 个偏移位置。

我们拿这 k 个偏移位置，去倒排索引（index.bin）中，查找 k 个单词对应的包含它的网页编号列表。  
经过这一步查询之后，我们得到了 k 个网页编号列表。
